#!/bin/bash

source ../settings/scripts/_common.sh
source /usr/share/yunohost/helpers

#=================================================
# RESTORE THE APP MAIN DIR
#=================================================
ynh_print_info "Restoring the app files..."

ynh_restore_everything

# Fix file permissions
chmod 0775 /etc/openvpn/
chown root:${app} /etc/openvpn/
mkdir -pm 0755 /etc/yunohost/hooks.d/post_iptable_rules/
chmod 0755 /etc/systemd/system/openvpn@.service.d/
chmod 0644 /etc/systemd/system/openvpn@.service.d/override.conf

# Fix file permissions in certificates directory
chmod 0700 /etc/openvpn/keys/
chown ${app}:${app} /etc/openvpn/keys/
find /etc/openvpn/keys -type f -exec chmod 0600 {} \;

# Ensure scripts are executable
chmod 0755 -R /etc/openvpn/scripts
chmod 0755 /usr/local/bin/$service_name
chmod 0755 /usr/local/bin/$service_checker_name.sh
chmod 0755 /usr/local/bin/$service_name-loadcubefile.sh

#=================================================
# RESTORE SYSTEMD
#=================================================
ynh_print_info "Restoring $app's systemd service..."

systemctl daemon-reload

# Set default inits
# The boot order of these services are important, so they are disabled by default
# and the vpnclient service handles them.
systemctl disable openvpn --quiet
systemctl stop openvpn

# main service

yunohost service add $service_name --description "Tunnels the internet traffic through a VPN" --need_lock --test_status="systemctl is-active openvpn@client.service" --log "/var/log/$app/ynh-vpnclient.log"
yunohost service enable "$service_name"

ynh_config_add_logrotate

# checker service

systemctl start "$service_checker_name"
systemctl enable "$service_checker_name" --quiet
systemctl start "$service_checker_name.timer"
systemctl enable "$service_checker_name.timer" --quiet

#=================================================
# ADVERTISE SERVICE IN ADMIN PANEL
#=================================================

#=================================================
# END OF SCRIPT
#=================================================

ynh_print_info "Restoration completed for $app"
